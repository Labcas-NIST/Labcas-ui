<!DOCTYPE html>
<html lang="en">
  <head>
    <div id="head_template"></div>
    <style>
      input.tt-input {
        width: 100px;
      }
      #downloadButtonsContainer {
            display: flex;
            flex-wrap: wrap;
            gap: 1px; /* This sets the spacing between buttons */
        }
        .btn-download {
            flex: 1 0 31%; /* Adjust the "21%" as needed to fit your layout */
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 40%;
        }
        /* Optional: If you want the first button (upload button) to stand out or be bigger */
        #jsonFileInputLabel {
            margin-bottom: 20px;
            display: block; /* Makes it a block element so it takes the full width */
        }
        .validation-message {
            font-size: 1rem; /* You can adjust the size as needed */
            margin-bottom: 0.5rem;
            color: #555; /* Dark grey color for standard text */
        }
        .validation-error {
            color: #d9534f; /* Bootstrap 'danger' color */
        }
        .validation-warning {
            color: #f0ad4e; /* Bootstrap 'warning' color */
        }
    </style>
  </head>
  <body class="sidebar-mini">
    <div class="wrapper">
      <div id='sidebar_placeholder'></div>
      <div id='load'>
        <br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br>
        <center>
          <img class="collapse show" height="200px" width="200px" src="/labcas-ui/assets/img/loading.gif?2">
        </center>
      </div>
      <div id="main-panel" class="main-panel" style="visibility:hidden">
        <!-- Navbar -->
        <div id="nav_template"></div>
        <!-- End Navbar -->
        <div class="content">
          <br>
          <br>
          <div class="container-fluid">
            <div class="row">
              <div class="col-lg-3 col-sm-6" id="collection_name_template"></div>
              <div class="col-lg-3 col-sm-6" id="dataset_stat_template"></div>
              <div class="col-lg-3 col-sm-6" id="file_stat_template"></div>
              <div class="col-lg-3 col-sm-6" id="download_collection_template"></div>
              <!--<div class="col-lg-3 col-sm-6" id="favorite_stat_template"></div>-->
            </div>
            <div class="row">
              <div class="col-md-12">
                <nav aria-label="breadcrumb">
                  <ol class="breadcrumb">
                    <li class="breadcrumb-item">
                      <a href="/labcas-ui/m/index.html">Home</a>
                    </li>
                    <li id="breadcrumb_collection" class="breadcrumb-item active" aria-current="page"></li>
                  </ol>
                </nav>
              </div>
            </div>
            <div class="row">

                <div class="col-md-12 ml-auto mr-auto" id="collection_level_gantt">
                  <div class="card card-tasks">
                    <div class="card-header ">
                      <h4 class="card-title">Cell Line Gantt</h4>
                      <p class="card-category">Explore or Download</p>
                    </div>
                    <div class="card-body" style="padding: 0px 15px 10px 15px">
                      <div class="table-full-width">
                        <div id="metadata_div2">
                          <iframe id="collection_level_gantt_frame" style="border: none; box-shadow: -2px 2px 2px 2px rgba(0,0,0,0.75); transform: translate(-2px, 2px);" height="350px" width="100%"></iframe>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
            </div>

            <div class="row">
              <div class="col-md-6">
                <div class="card ">
                  <div class="card-header">
                    <h4 class="card-title">
                      <div id="collectiontitle"></div>
                    </h4>
                    <p class="card-category">Collection Details</p>
                  </div>
                  <div class="card-body">
                    <div class="table-responsive">
                      <table class="table" id="collectiondetails-table" style="table-layout: fixed;">
                        <tbody>
                          <center>
                            <img id="loading_collection" class="collapse show" height="50px" width="50px" src="/labcas-ui/assets/img/loading.gif">
                          </center>
                        </tbody>
                      </table>
                    </div>
                  </div>
                  <div class="card card-tasks" id="collection_level_pcoa">
                    <div class="card-header ">
                      <h4 class="card-title">PCoA Analysis</h4>
                      <p class="card-category">Interactively Explore</p>
                    </div>
                    <div class="card-body" style="padding: 0px 15px 10px 15px">
                      <div class="table-full-width">
                        <div id="collection_level_pcoa_div">
                          <center>
                            <iframe id="collection_level_pcoa_frame" style="border: none; box-shadow: -2px 2px 2px 2px rgba(0,0,0,0.75); transform: translate(-2px, 2px);" height="450px" width="100%"></iframe>
                          </center>
                        </div>
                      </div>
                    </div>
                </div>

                </div>
              </div>
              <div class="col-md-6 ml-auto mr-auto">
                <div class="col-md-12 ml-auto mr-auto" id="collection_level_files">
                  <div class="card card-tasks">
                    <div class="card-header ">
                      <h4 class="card-title">Dataset Level Documents</h4>
                      <p class="card-category">Interactively Explore</p>
                    </div>
                    <div class="card-body" style="padding: 0px 15px 10px 15px">
                      <div class="table-full-width">
                        <div id="metadata_div">
                          <center>
                            <img id="loading_metadata" class="collapse show" height="50px" width="50px" src="/labcas-ui/assets/img/loading.gif">
                          </center>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
                <div class="col-md-12 ml-auto mr-auto" id="datasets_in_collection">
                  <div class="card card-tasks">
                    <div class="card-header">
                      <h4 class="card-title">Datasets in this Collection</h4>
                      <p class="card-category">Explore or Download</p>
                    </div>
                    <div class="card-body">
                      <!-- Hierarchy mode selection -->
                      <style>
                        .hierarchy-radio-group {
                          display: flex;
                          flex-direction: column;
                          width: 95%;
                          margin: 0 auto 1rem auto;
                          padding-left: 1.5rem;
                          padding-right: 1.5rem;
                          box-sizing: border-box;
                        }
                        .hierarchy-radio-group .form-check {
                          margin-bottom: 0.5rem;
                          align-items: flex-start;
                        }
                        .hierarchy-radio-group .form-check-input {
                          width: 1.25em;
                          height: 1.25em;
                          margin-top: 0.2em;
                        }
                        .hierarchy-radio-group .form-check-label {
                          font-size: 1rem;
                          line-height: 1.5;
                          font-weight: 400;
                          color: #222;
                          margin-left: 0.75em;
                          word-break: break-word;
                          white-space: normal;
                        }
                      </style>
                      <div class="hierarchy-radio-group">
                        <div class="form-check">
                          <input class="form-check-input" type="radio" name="hierarchyMode" id="radio_native_hierarchy" value="native">
                          <label class="form-check-label" for="radio_native_hierarchy">
                            Datasets - Uploaded Native Hierarchy
                          </label>
                        </div>
                        <div class="form-check">
                          <input class="form-check-input" type="radio" name="hierarchyMode" id="radio_default_hierarchy" value="default" checked>
                          <label class="form-check-label" for="radio_default_hierarchy" id="default_hierarchy_label">
                            Default -
                            <span id="default_hierarchy_tags_label">WorkingGroup | InstrumentCode | SiteCode | ProtocolID | ExperimentType | SampleName</span>
                          </label>
                        </div>
                      </div>
                      <div class="d-flex align-items-center mb-2">
                        <span style="width: 300px">Build your own hierarchy:&nbsp;</span>
                        <select id="view_tag_select" class="form-control input-sm" data-style="btn-default btn-outline" data-menu-style="dropdown-blue" style="max-width: 300px;">
                          <option>Select Metadata Tags</option>
                          <!-- More options dynamically populated -->
                        </select>
                      </div>
                      <input id="view_tags" type="text" value="" class="mb-2" />
                      <div class="d-flex align-items-center mb-2">
                        <input type="checkbox" id="virtual_expand_all" class="form-control" style="width:20px;height:20px; display: none;">
                        <div id="virtual_expand_all_label" style="line-height: 20px; display: none;">&nbsp;Expand All?</div>
                      </div>
                      <div class="table-full-width">
                        <div id="hierarchy_">
                          <center>
                            <img id="loading_hierarchy" class="collapse hide" height="50px" width="50px" src="/labcas-ui/assets/img/loading.gif">
                          </center>
                        </div>
                        <div id="datasets-table">
                          <center>
                            <img id="loading_dataset" class="collapse show" height="50px" width="50px" src="/labcas-ui/assets/img/loading.gif">
                          </center>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
              <div id='collection_level_schema_div' class="col-md-12 ml-auto mr-auto">
                  <div class="card card-tasks" id="collection_level_schema_metadata">
                    <div class="card-header ">
                      <h4 class="card-title">Schema Metadata</h4>
                      <p class="card-category">Interactively Explore</p>
                    </div>
                    <div class="card-body" style="padding: 0px 15px 10px 15px">
                      <div class="table-full-width">
                        <div id="collection_level_pcoa_div">
                          <center>
                            <iframe id="collection_level_schema_metadata_frame" style="border: none;" height="700px" width="100%"></iframe>
                          </center>
                        </div>
                      </div>
                    </div>
                </div>
              </div>
            </div>
            <footer role='contentinfo' class='labcas-footer' id="footer_template"></footer>
          </div>
        </div>
      </div>
    </div>
    </div>
    <div class="modal fade modal-mini modal-primary" id="redirectModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
      <div class="modal-dialog" style="max-width: 1000px">
        <div class="modal-content" style="width: 1000px">
          <div class="modal-header justify-content-center">
            <div class="modal-profile">
              <i class="nc-icon nc-bell-55"></i>
            </div>
          </div>
          <div class="modal-body">
            <p>
            <center><div id='download_warning'></div></center>
            </p>
          </div>
          <div class="modal-footer">
            <button type="submit" id="redirectModal_continue" onclick="window.location.replace('/labcas-ui/download.html?version=5.1.0')" class="btn btn-info btn-fill pull-right" data-dismiss="modal">Continue</button>
            <button type="submit" class="btn btn-warning btn-fill pull-right" data-dismiss="modal">Close</button>
          </div>
        </div>
      </div>
    </div>
  </body>
  <!--   Core JS Files   -->
  <script src="/labcas-ui/assets/js/core/jquery-3.5.1.min.js" type="text/javascript"></script>
  <script src="/labcas-ui/assets/js/core/popper.min.js" type="text/javascript"></script>
  <script src="/labcas-ui/assets/js/core/bootstrap.min.js" type="text/javascript"></script>
  <!--  Plugin for Switches, full documentation here: http://www.jque.re/plugins/version3/bootstrap.switch/ -->
  <script src="/labcas-ui/assets/js/plugins/bootstrap-switch.js"></script>
  <!--  Chartist Plugin  -->
  <script src="/labcas-ui/assets/js/plugins/chartist.min.js"></script>
  <!--  Notifications Plugin    -->
  <script src="/labcas-ui/assets/js/plugins/bootstrap-notify.js"></script>
  <!--  jVector Map  -->
  <script src="/labcas-ui/assets/js/plugins/jquery-jvectormap.js" type="text/javascript"></script>
  <!--  Plugin for Date Time Picker and Full Calendar Plugin-->
  <script src="/labcas-ui/assets/js/plugins/moment.min.js"></script>
  <!--  DatetimePicker   -->
  <script src="/labcas-ui/assets/js/plugins/bootstrap-datetimepicker.js"></script>
  <!--  Sweet Alert  -->
  <script src="/labcas-ui/assets/js/plugins/sweetalert2.min.js" type="text/javascript"></script>
  <!--  Tags Input  -->
  <script src="/labcas-ui/assets/js/plugins/bootstrap-tagsinput.js" type="text/javascript"></script>
  <!--  Sliders  -->
  <script src="/labcas-ui/assets/js/plugins/nouislider.js" type="text/javascript"></script>
  <!--  Bootstrap Select  -->
  <script src="/labcas-ui/assets/js/plugins/bootstrap-selectpicker.js" type="text/javascript"></script>
  <!--  jQueryValidate  -->
  <script src="/labcas-ui/assets/js/plugins/jquery.validate.min.js" type="text/javascript"></script>
  <!--  Plugin for the Wizard, full documentation here: https://github.com/VinceG/twitter-bootstrap-wizard -->
  <script src="/labcas-ui/assets/js/plugins/jquery.bootstrap-wizard.js"></script>
  <!--  Bootstrap Table Plugin -->
  <script src="/labcas-ui/assets/js/plugins/bootstrap-table.js"></script>
  <!--  DataTable Plugin -->
  <script src="/labcas-ui/assets/js/plugins/jquery.dataTables.min.js"></script>
  <script src="/labcas-ui/assets/js/vendor/jquery-ui-1.12.1.min.js"></script>
  <!--  Full Calendar   -->
  <script src="/labcas-ui/assets/js/plugins/fullcalendar.min.js"></script>
  <!-- Control Center for Now Ui Dashboard: parallax effects, scripts for the example pages etc -->
  <script src="/labcas-ui/assets/js/light-bootstrap-dashboard.js?v=2.0.1&2" type="text/javascript"></script>
  <script src="/labcas-ui/assets/js/plugins/js.cookie.js"></script>
  <script src="/labcas-ui/assets/js/plugins/typeahead.bundle.js"></script>
  <script src="/labcas-ui/assets/js/labcas/labcas-sidebar.js"></script>
  <script src="/labcas-ui/assets/js/labcas/authentication.js?version=5.1.0"></script>
  <script src="/labcas-ui/assets/js/labcas/utils.js?version=5.1.0"></script>
  <script src="/labcas-ui/assets/js/labcas/search.js?version=5.1.0"></script>
  <script src="/labcas-ui/assets/js/labcas/collections.js?version=5.1.1"></script>
  <script src="/labcas-ui/assets/js/labcas/hierarchy_filter_utils_fast.js?version=5.1.0"></script>
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-X0YH110WES"></script> <script> window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'G-X0YH110WES'); </script>
  <script type="text/javascript">
    var get_var = get_url_vars();
    var dataset_id = get_var["collection_id"] + "/" + get_var["collection_id"];

    // Function to update the Default radio label with tags for the current collection
    function updateDefaultRadioLabel() {
      $.getJSON('/labcas-ui/assets/conf/environment.cfg', function(cfg) {
        var collection = get_var["collection_id"];
        var tags = "WorkingGroup,InstrumentCode,SiteCode,ProtocolID,ExperimentType,SampleName";
        if (
          cfg &&
          cfg.collection_custom_hierarchy_default &&
          cfg.collection_custom_hierarchy_default[collection]
        ) {
          tags = cfg.collection_custom_hierarchy_default[collection];
        }
        var tagList = tags.split(',').join(' | ');
        $('#default_hierarchy_tags_label').text(tagList);
      });
    }
    // Call on page load
    updateDefaultRadioLabel();

    // Also call after sidebar, breadcrumb, or main content loads (AJAX navigation)
    $("#sidebar_placeholder").on("load", updateDefaultRadioLabel);
    $("#breadcrumb_collection").on("DOMSubtreeModified", updateDefaultRadioLabel);
    // If you have a main content AJAX load, add a similar call here

    document.onreadystatechange = function() {
      var state = document.readyState
      if (state == 'interactive') {
        document.getElementById('main-panel').style.visibility = "hidden";
      } else if (state == 'complete') {
        setTimeout(function() {
          document.getElementById('load').style.display = "none";
          document.getElementById('main-panel').style.visibility = "visible";
        }, 1000);
      }
    }

    $(document).ready(function() {
      initCookies();
      $("#head_template").load("/labcas-ui/templates.html #head_template");
      $("#nav_template").load("/labcas-ui/templates.html?2 #nav_template", function() {
        $("#username_placeholder_second").text(Cookies.get('user'));
        if (Cookies.get('user') == "Sign in") {
          $("#username_placeholder_third").text(Cookies.get('user'));
          $("#loggedout_msg").show();
        } else {
          $("#loggedout_msg").hide();
        }
      });
      //$("#favorite_stat_template").load("/labcas-ui/templates.html #favorite_stat_template");

      $("#download_collection_template").load("/labcas-ui/templates.html?version=5.1.0 #download_collection_template");
      $("#file_stat_template").load("/labcas-ui/templates.html #file_stat_template");
      $("#dataset_stat_template").load("/labcas-ui/templates.html #dataset_stat_template");
      $("#collection_name_template").load("/labcas-ui/templates.html #collection_name_template");
      $("#footer_template").load("/labcas-ui/templates.html #footer_template_" + localStorage.getItem("environment_name"));
      $("#sidebar_placeholder").load("/labcas-ui/sidebar_" + localStorage.getItem("environment_name") + ".html?9");
      Cookies.set("login_redirect", "/labcas-ui/c/index.html?collection_id=" + get_var["collection_id"]);
      $("#breadcrumb_collection").text(get_var["collection_id"].replace(/_/g, " "));
      if (get_var["collection_id"] != "Cell_Line_Provenance") {
        $("#collection_level_gantt").hide();
      }else{
        $('#collection_level_gantt_frame').attr('src', '/labcas-ui/a/gantt2.html');
      }

      $('#collection_level_schema_metadata_frame').attr('src', '/labcas-ui/a/metadata_tables.html?collection_id='+get_var["collection_id"]);
        $("#collection_level_pcoa").hide();
        $("#collection_level_schema_metadata").hide();
      //Setup view tags
      var tagValues = [];
      var states = new Bloodhound({
        datumTokenizer: Bloodhound.tokenizers.obj.whitespace('value'),
        queryTokenizer: Bloodhound.tokenizers.whitespace,
        local: $.map(tagValues, function(tagValue) {
          return {
            value: tagValue
          };
        })
      });
      states.initialize();
      var elt = $('#view_tags');
      elt.tagsinput({
        itemValue: "value",
        typeaheadjs: {
          displayKey: 'value',
          source: states.ttAdapter()
        }
      });

      $('.bootstrap-tagsinput').sortable({
            items: 'span.badge.badge-azure',
            cancel: '.bootstrap-tagsinput input',
            stop: function(event, ui) {

                var newTagsOrder = [];
                $(this).find('span.badge.badge-azure').each(function() {
                    // Extract the text of the tag
                    var tagText = $(this).contents().filter(function() {
                        return this.nodeType === 3; // Node.TEXT_NODE
                    }).text().trim();
                    newTagsOrder.push({ value: tagText });
                });

                elt.tagsinput('removeAll');
                newTagsOrder.forEach(function(tagObj) {
                    elt.tagsinput('add', tagObj);
                });

                $('#hierarchy_').html("");
                generate_hierarchy_based_on_tags().catch((error) => console.error(error));
                localStorage.setItem("hierarchy_tags_" + localStorage.getItem('last_collection_id'), elt.val());
            }
        }).disableSelection();

      // Radio button logic for hierarchy mode selection
      $('input[name="hierarchyMode"]').change(function() {
        if (this.value === "native") {
          // Simulate "Native Hierarchy" selection
          $('#hierarchy_').hide();
          $('#datasets-table').show();
          $('#virtual_expand_all').hide();
          $('#virtual_expand_all_label').hide();
          $('#view_tag_select').prop('disabled', true);
          $('#view_tags').prop('disabled', true);
        } else if (this.value === "default") {
          // Enable dropdown and tagsinput for custom tag management
          $('#datasets-table').hide();
          $('#hierarchy_').show();
          $('#virtual_expand_all').show();
          $('#virtual_expand_all_label').show();
          $('#view_tag_select').prop('disabled', false);
          $('#view_tags').prop('disabled', false);
        }
      });

      // Set initial state for default mode (enabled)
      $('#view_tag_select').prop('disabled', false);
      $('#view_tags').prop('disabled', false);

      $('#view_tag_select').change(function() {
        // Only allow custom tag selection if "Default" radio is selected
        if ($('input[name="hierarchyMode"]:checked').val() === "default") {
          $('#datasets-table').hide();
          $('#hierarchy_').show();
          $('#virtual_expand_all').show();
          $('#virtual_expand_all_label').show();
          elt.tagsinput('add', {
            "value": this.value
          });
          generate_hierarchy_based_on_tags().catch((error) => console.error(error));
        }
      });
      localStorage.setItem("current_collection_id", get_var["collection_id"]);

      elt.on('itemAdded itemRemoved', function(event) {
        $('.bootstrap-tagsinput').sortable('refresh');

        $('#hierarchy_').html("");
        
        if (event.type == "itemRemoved"){
            generate_hierarchy_based_on_tags().catch((error) => console.error(error));
        }

        localStorage.setItem("hierarchy_tags_" + get_var["collection_id"], elt.val());
        if (elt.val() == "") {
          $('#hierarchy_').hide();
          $('#virtual_expand_all').hide();
          $('#virtual_expand_all_label').hide();
          //$('#datasets-table').show();
        }
      });



      $('.twitter-typeahead').hide();
      //setTimeout(function() {
        localStorage.setItem("last_collection_id", get_var["collection_id"]);
        init_file_checkboxes('none');
        collection_hierarchy_get(get_var["collection_id"]);
        setup_labcas_data("collectiondatasets", 'id:"' + get_var["collection_id"] + '"', 'CollectionId:"' + get_var["collection_id"] + '"');
          //var hierarchy_tags = get_hierarchy_selected_upto(1000);
          //query_labcas_api(localStorage.getItem('environment')+"/data-access-api/files/select?q=CollectionId:"+get_var["collection_id"]+"%20AND%20-FolderType:%5B*%20TO%20*%5D&wt=json&indent=true&rows=5000&fl="+hierarchy_tags.join(","), fill_hierarchy_data_fast, true);
        
      //}, 1000);

     
    });

    // When the user navigates away from the page, save the scroll position
    window.addEventListener('beforeunload', function() {
        localStorage.setItem('collection_scrollPosition', window.scrollY);
    });

    // When the user returns to the page, restore the scroll position
    window.addEventListener('DOMContentLoaded', function() {
        if(localStorage.getItem('collection_scrollPosition') !== null) {
            window.scrollTo(0, localStorage.getItem('collection_scrollPosition'));
        }
    });

  </script>
</html>

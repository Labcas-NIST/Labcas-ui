<!DOCTYPE html>
<html lang="en">
  <head>
    <div id="head_template"></div>
  </head>
  <body class="sidebar-mini">
    <div class="wrapper">
      <div id='sidebar_placeholder'></div>
      <div id='load'>
        <br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br>
        <center>
          <img class="collapse show" height="200px" width="200px" src="/labcas-ui/assets/img/loading.gif?2">
        </center>
      </div>
      <div id="main-panel" class="main-panel" style="visibility:hidden">
        <!-- Navbar -->
        <div id="nav_template"></div>
        <!-- End Navbar -->
        <div class="content">
          <br>
          <br>
          <div class="container-fluid">
            <div class="row">
              <div class="col-lg-3 col-sm-6" id="collection_name_template"></div>
              <div class="col-lg-3 col-sm-6" id="dataset_stat_template"></div>
              <div class="col-lg-3 col-sm-6" id="file_stat_template"></div>
              <!--<div class="col-lg-3 col-sm-6" id="favorite_stat_template"></div>-->
            </div>
            <div class="row">
              <div class="col-md-12">
                <nav aria-label="breadcrumb">
                  <ol class="breadcrumb">
                    <li class="breadcrumb-item">
                      <a href="/labcas-ui/m/index.html">Home</a>
                    </li>
                    <li id="breadcrumb_collection" class="breadcrumb-item active" aria-current="page"></li>
                  </ol>
                </nav>
              </div>
            </div>
            <div class="row">

                <div class="col-md-12 ml-auto mr-auto" id="collection_level_gantt">
                  <div class="card card-tasks">
                    <div class="card-header ">
                      <h4 class="card-title">Cell Line Gantt</h4>
                      <p class="card-category">Explore or Download</p>
                    </div>
                    <div class="card-body" style="padding: 0px 15px 10px 15px">
                      <div class="table-full-width">
                        <div id="metadata_div2">
                          <iframe id="collection_level_gantt_frame" style="border: none; box-shadow: -2px 2px 2px 2px rgba(0,0,0,0.75); transform: translate(-2px, 2px);" height="350px" width="100%"></iframe>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
            </div>

            <div class="row">
              <div class="col-md-6">
                <div class="card ">
                  <div class="card-header">
                    <h4 class="card-title">
                      <div id="collectiontitle"></div>
                    </h4>
                    <p class="card-category">Collection Details</p>
                  </div>
                  <div class="card-body">
                    <div class="table-responsive">
                      <table class="table" id="collectiondetails-table" style="table-layout: fixed;">
                        <tbody>
                          <center>
                            <img id="loading_collection" class="collapse show" height="50px" width="50px" src="/labcas-ui/assets/img/loading.gif">
                          </center>
                        </tbody>
                      </table>
                    </div>
                  </div>
                  <div class="card card-tasks" id="collection_level_pcoa">
                    <div class="card-header ">
                      <h4 class="card-title">PCoA Analysis</h4>
                      <p class="card-category">Interactively Explore</p>
                    </div>
                    <div class="card-body" style="padding: 0px 15px 10px 15px">
                      <div class="table-full-width">
                        <div id="collection_level_pcoa_div">
                          <center>
                            <iframe id="collection_level_pcoa_frame" style="border: none; box-shadow: -2px 2px 2px 2px rgba(0,0,0,0.75); transform: translate(-2px, 2px);" height="450px" width="100%"></iframe>
                          </center>
                        </div>
                      </div>
                    </div>
                </div>

                </div>
              </div>
              <div class="col-md-6 ml-auto mr-auto">
                <div class="col-md-12 ml-auto mr-auto" id="collection_level_files">
                  <div class="card card-tasks">
                    <div class="card-header ">
                      <h4 class="card-title">Collection Level Files</h4>
                      <p class="card-category">Interactively Explore</p>
                    </div>
                    <div class="card-body" style="padding: 0px 15px 10px 15px">
                      <div class="table-full-width">
                        <div id="metadata_div">
                          <center>
                            <img id="loading_metadata" class="collapse show" height="50px" width="50px" src="/labcas-ui/assets/img/loading.gif">
                          </center>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
                <div class="col-md-12 ml-auto mr-auto" id="datasets_in_collection">
                  <div class="card card-tasks">
                    <div class="card-header ">
                      <h4 class="card-title">Datasets in this Collection</h4>
                      <p class="card-category">Explore or Download</p>
                    </div>
                    <div class="card-body"> Add Folder Grouping Heirarchy:
                      <hr style="padding:0; padding-bottom:5px; margin: 0">
                      <input id="view_tags" type="text" value="" />
                      <div>
                          <div class="row"><div class="col-md-8"><select id="view_tag_select" class="form-control input-sm" data-style="btn-default btn-outline" data-menu-style="dropdown-blue"><option>Default</option></select> </div> <div class="col-md-1"><input type="checkbox" id="virtual_expand_all" class="form-control" style="display: none; width:36px;height:36px"></div><div class="col-md-3" id="virtual_expand_all_label" style="line-height: 36px; display: none">Expand All?</div></div>
                          <!--<div class="row"><div class="col-md-8"><select id="view_tag_select" class="form-control input-sm" data-style="btn-default btn-outline" data-menu-style="dropdown-blue"><option>Native Hierarchy</option><option>Default</option></select> </div> <div class="col-md-1"><input type="checkbox" id="virtual_expand_all" class="form-control" style="display: none; width:36px;height:36px"></div><div class="col-md-3" id="virtual_expand_all_label" style="line-height: 36px; display: none">Expand All?</div></div>-->
                        <div class="table-full-width">
                          <div id="hierarchy_">
                            <center>
                              <img id="loading_hierarchy" class="collapse hide" height="50px" width="50px" src="/labcas-ui/assets/img/loading.gif">
                            </center>
                          </div>
                          <div id="datasets-table">
                            <center>
                              <img id="loading_dataset" class="collapse show" height="50px" width="50px" src="/labcas-ui/assets/img/loading.gif">
                            </center>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
              </div>
            </div>
            <footer role='contentinfo' class='labcas-footer' id="footer_template"></footer>
          </div>
        </div>
      </div>
    </div>
    </div>
    <div class="modal fade modal-mini modal-primary" id="redirectModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
      <div class="modal-dialog" style="max-width: 1000px">
        <div class="modal-content" style="width: 1000px">
          <div class="modal-header justify-content-center">
            <div class="modal-profile">
              <i class="nc-icon nc-bell-55"></i>
            </div>
          </div>
          <div class="modal-body">
            <p>
            <center><div id='download_warning'></div></center>
            </p>
          </div>
          <div class="modal-footer">
            <button type="submit" id="redirectModal_continue" onclick="window.location.replace('/labcas-ui/download.html?version=3.0.0')" class="btn btn-info btn-fill pull-right" data-dismiss="modal">Continue</button>
            <button type="submit" class="btn btn-warning btn-fill pull-right" data-dismiss="modal">Close</button>
          </div>
        </div>
      </div>
    </div>
  </body>
  <!--   Core JS Files   -->
  <script src="/labcas-ui/assets/js/core/jquery-3.5.1.min.js" type="text/javascript"></script>
  <script src="/labcas-ui/assets/js/core/popper.min.js" type="text/javascript"></script>
  <script src="/labcas-ui/assets/js/core/bootstrap.min.js" type="text/javascript"></script>
  <!--  Plugin for Switches, full documentation here: http://www.jque.re/plugins/version3/bootstrap.switch/ -->
  <script src="/labcas-ui/assets/js/plugins/bootstrap-switch.js"></script>
  <!--  Chartist Plugin  -->
  <script src="/labcas-ui/assets/js/plugins/chartist.min.js"></script>
  <!--  Notifications Plugin    -->
  <script src="/labcas-ui/assets/js/plugins/bootstrap-notify.js"></script>
  <!--  jVector Map  -->
  <script src="/labcas-ui/assets/js/plugins/jquery-jvectormap.js" type="text/javascript"></script>
  <!--  Plugin for Date Time Picker and Full Calendar Plugin-->
  <script src="/labcas-ui/assets/js/plugins/moment.min.js"></script>
  <!--  DatetimePicker   -->
  <script src="/labcas-ui/assets/js/plugins/bootstrap-datetimepicker.js"></script>
  <!--  Sweet Alert  -->
  <script src="/labcas-ui/assets/js/plugins/sweetalert2.min.js" type="text/javascript"></script>
  <!--  Tags Input  -->
  <script src="/labcas-ui/assets/js/plugins/bootstrap-tagsinput.js" type="text/javascript"></script>
  <!--  Sliders  -->
  <script src="/labcas-ui/assets/js/plugins/nouislider.js" type="text/javascript"></script>
  <!--  Bootstrap Select  -->
  <script src="/labcas-ui/assets/js/plugins/bootstrap-selectpicker.js" type="text/javascript"></script>
  <!--  jQueryValidate  -->
  <script src="/labcas-ui/assets/js/plugins/jquery.validate.min.js" type="text/javascript"></script>
  <!--  Plugin for the Wizard, full documentation here: https://github.com/VinceG/twitter-bootstrap-wizard -->
  <script src="/labcas-ui/assets/js/plugins/jquery.bootstrap-wizard.js"></script>
  <!--  Bootstrap Table Plugin -->
  <script src="/labcas-ui/assets/js/plugins/bootstrap-table.js"></script>
  <!--  DataTable Plugin -->
  <script src="/labcas-ui/assets/js/plugins/jquery.dataTables.min.js"></script>
  <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js"></script>
  <!--  Full Calendar   -->
  <script src="/labcas-ui/assets/js/plugins/fullcalendar.min.js"></script>
  <!-- Control Center for Now Ui Dashboard: parallax effects, scripts for the example pages etc -->
  <script src="/labcas-ui/assets/js/light-bootstrap-dashboard.js?v=2.0.1&2" type="text/javascript"></script>
  <script src="/labcas-ui/assets/js/plugins/js.cookie.js"></script>
  <script src="/labcas-ui/assets/js/plugins/typeahead.bundle.js"></script>
  <script src="/labcas-ui/assets/js/labcas/labcas-sidebar.js"></script>
  <script src="/labcas-ui/assets/js/labcas/authentication.js?version=3.0.0"></script>
  <script src="/labcas-ui/assets/js/labcas/utils.js?version=3.0.1"></script>
  <script src="/labcas-ui/assets/js/labcas/search.js?version=3.0.0"></script>
  <script src="/labcas-ui/assets/js/labcas/collections.js?version=3.0.4"></script>
  <script src="/labcas-ui/assets/js/labcas/hierarchy_filter_utils_fast.js?version=3.2.0"></script>
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-X0YH110WES"></script> <script> window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'G-X0YH110WES'); </script>
  <script type="text/javascript">
    $(document).ready(function() {
		initPage();
		configurePageBasedOnCollection();
		initializeTagSystem();
		handleViewTagSelection();
		managePageUnloading();
	});
	
	function initPage() {
		initCookies();
		$('#viewer_content').hide();
		loadTemplates();
		setInitialCollectionData();
	}
	
	function loadTemplates() {
		$("#head_template").load("/labcas-ui/templates.html #head_template");
		$("#nav_template").load("/labcas-ui/templates.html?2 #nav_template", updateUserStatus);
		$("#file_stat_template, #dataset_stat_template, #collection_name_template").each(function() {
			var templateId = $(this).attr('id');
			$(`#${templateId}`).load(`/labcas-ui/templates.html #${templateId}`);
		});
		$("#footer_template").load("/labcas-ui/templates.html #footer_template_" + localStorage.getItem("environment_name"));
		$("#sidebar_placeholder").load("/labcas-ui/sidebar_" + localStorage.getItem("environment_name") + ".html?9");
	}
	
	function updateUserStatus() {
		var user = Cookies.get('user');
		$("#username_placeholder_second").text(user);
		if (user === "Sign in") {
			$("#username_placeholder_third").text(user);
			$("#loggedout_msg").show();
		} else {
			$("#loggedout_msg").hide();
		}
	}
	
	function setInitialCollectionData() {
		var collectionId = get_url_vars()["collection_id"];
		Cookies.set("login_redirect", `/labcas-ui/c/index.html?collection_id=${collectionId}`);
		$("#breadcrumb_collection").text(collectionId.replace(/_/g, " "));
	
		if (collectionId === "Cell_Line_Provenance") {
			$('#collection_level_gantt_frame').attr('src', '/labcas-ui/a/gantt2.html');
		} else {
			$("#collection_level_gantt").hide();
		}
	
		if (collectionId === "Microbial") {
			$('#collection_level_pcoa_frame').attr('src', '/labcas-ui/a/pca.html');
		} else {
			$("#collection_level_pcoa").hide();
		}
	}
	
	function initializeTagSystem() {
		var states = new Bloodhound({
			datumTokenizer: Bloodhound.tokenizers.obj.whitespace('value'),
			queryTokenizer: Bloodhound.tokenizers.whitespace,
			local: []
		});
		states.initialize();
	
		var elt = $('#view_tags');
		elt.tagsinput({
			itemValue: "value",
			typeaheadjs: {
				displayKey: 'value',
				source: states.ttAdapter()
			}
		});
	
		$('.bootstrap-tagsinput').sortable({
			items: 'span.badge.badge-azure',
			cancel: '.bootstrap-tagsinput input',
			stop: updateTagsOrder
		}).disableSelection();
	}
	
	function updateTagsOrder(event, ui) {
		var elt = $('#view_tags');
		elt.tagsinput('removeAll');
		$(this).find('span.badge.badge-azure').each(function() {
			elt.tagsinput('add', { value: $(this).text().trim() });
		});
		console.log(elt.val());
		$('#hierarchy_').html("");
		generate_hierarchy_based_on_tags().catch(console.error);
		localStorage.setItem("hierarchy_tags_" + localStorage.getItem('last_collection_id'), elt.val());
	}
	
	function handleViewTagSelection() {
		$('#view_tag_select').change(function() {
			var selection = $(this).val();
			if (selection !== "Native Hierarchy") {
				$('#datasets-table').hide();
				$('#hierarchy_').show();
				$('#virtual_expand_all, #virtual_expand_all_label').show();
				if (selection === "Default") {
					collection_hierarchy_default();
				} else {
					$('#view_tags').tagsinput('add', { value: selection });
					console.log("add123");
					generate_hierarchy_based_on_tags().catch(console.error);
				}
			} else {
				$('#hierarchy_').hide();
				$('#datasets-table').show();
				$('#virtual_expand_all, #virtual_expand_all_label').hide();
			}
		});
	}
	
	function managePageUnloading() {
		window.addEventListener('beforeunload', function() {
			localStorage.setItem('collection_scrollPosition', window.scrollY);
		});
	
		window.addEventListener('DOMContentLoaded', function() {
			if (localStorage.getItem('collection_scrollPosition') !== null) {
				window.scrollTo(0, localStorage.getItem('collection_scrollPosition'));
			}
		});
	}
  </script>
</html>

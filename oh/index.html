<!DOCTYPE html>
<html lang="en">

<head>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-LQ79946QV2"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'G-LQ79946QV2');
    </script>
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
	<title>LabCAS</title>
        <div id="head_template"></div>
	<script async type="text/javascript" id="_fed_an_ua_tag" src="https://dap.digitalgov.gov/Universal-Federated-Analytics-Min.js?agency=NASA&subagency=JPL-edrn-labcas"></script>
</head>

<body class="sidebar-mini">
    <div class="wrapper" >
        <div id='sidebar_placeholder'></div>
        <!-- Navbar -->
        <div id="nav_template"></div>
        <div class="main-panel" style="width:100%">
            
            <!-- End Navbar -->
            <div class="content" style="padding:0">
                <div class="container-fluid">
                    <div class="row">
                    	<div class="col-md-12">
                          <nav aria-label="breadcrumb">
                          <ol id="breadcrumb" class="breadcrumb"></ol>
                        </nav>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-12">
                            <div >
                                <div>
                                                <iframe id="dicomViewer" frameBorder="0" height="800px" width="100%" ></iframe>
                                </div>
                        </div>
                </div>
            </div>
            </div>
	    </div>
    <footer role='contentinfo' class='labcas-footer'  id="footer_template">
    </footer>
</div>
                          
<script>
  // Fetch and log the contents of simulated.json with additional diagnostics
  fetch('/labcas-ui/simulated.json?t=' + Date.now())
    .then(response => {
      if (!response.ok) {
        throw new Error('Network response was not ok ' + response.status);
      }
      return response.text();
    })
    .then(data => {
      console.log("simulated.json content (raw):", data);
      try {
        const json = JSON.parse(data);
        const studies = Array.isArray(json.studies) ? json.studies : [];
        const modalityCounts = {};
        const presentSeries = new Set();
        const rtstructRefs = [];

        studies.forEach((st, si) => {
          const seriesArr = Array.isArray(st.series) ? st.series : [];
          seriesArr.forEach((se, sj) => {
            const modality = se.Modality || (se.instances && se.instances[0] && se.instances[0].metadata && se.instances[0].metadata.Modality);
            modalityCounts[modality] = (modalityCounts[modality] || 0) + 1;
            if (se.SeriesInstanceUID) presentSeries.add(se.SeriesInstanceUID);

            // Extract RTSTRUCT references from instance metadata, if any
            if (modality === 'RTSTRUCT') {
              try {
                const inst = (se.instances && se.instances[0]) || {};
                const md = inst.metadata || {};
                const rfor = md.ReferencedFrameOfReferenceSequence || [];
                const refStudies = (rfor[0] && rfor[0].RTReferencedStudySequence) ? rfor[0].RTReferencedStudySequence : [];
                const refSeries = (refStudies[0] && refStudies[0].ReferencedSeriesSequence) ? refStudies[0].ReferencedSeriesSequence : [];
                const refSeriesUIDs = refSeries.map(s => s.SeriesInstanceUID).filter(Boolean);
                rtstructRefs.push({ seriesUID: se.SeriesInstanceUID, refSeriesUIDs });
              } catch (e) {
                console.warn('OHIF launcher: failed to parse RTSTRUCT references for series', se.SeriesInstanceUID, e);
              }
            }
          });
        });

        console.log('OHIF launcher summary:', {
          studyCount: studies.length,
          modalityCounts: modalityCounts,
          presentSeriesCount: presentSeries.size
        });

        // Warn if RTSTRUCT references point to series not present in JSON
        rtstructRefs.forEach(ref => {
          (ref.refSeriesUIDs || []).forEach(uid => {
            if (!presentSeries.has(uid)) {
              console.warn('OHIF launcher WARNING: RTSTRUCT references missing target series', { rtSeriesUID: ref.seriesUID, referencedSeriesUID: uid });
            }
          });
        });
      } catch (e) {
        console.warn('OHIF launcher: failed to parse simulated.json for diagnostics', e);
      }
    })
    .catch(error => {
      console.error("Error fetching simulated.json:", error);
    });
</script>
<!-- Viewer loading progress modal -->
<div class="modal fade" id="viewerProgressModal" tabindex="-1" role="dialog" aria-labelledby="viewerProgressLabel" aria-hidden="true">
  <div class="modal-dialog modal-sm modal-dialog-centered" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="viewerProgressLabel">Loading Viewer...</h5>
      </div>
      <div class="modal-body">
        <div class="progress">
          <div id="viewerProgressBar" class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width:100%" aria-valuenow="100" aria-valuemin="0" aria-valuemax="100">Loading</div>
        </div>
      </div>
    </div>
  </div>
</div>
</body>
<!--   Core JS Files   -->
<script src="/labcas-ui/assets/js/core/jquery-3.5.1.min.js" type="text/javascript"></script>
<script src="/labcas-ui/assets/js/core/popper.min.js" type="text/javascript"></script>
<script src="/labcas-ui/assets/js/core/bootstrap.min.js" type="text/javascript"></script>
<!--  Plugin for Switches, full documentation here: http://www.jque.re/plugins/version3/bootstrap.switch/ -->
<script src="/labcas-ui/assets/js/plugins/bootstrap-switch.js"></script>
<!--  Chartist Plugin  -->
<script src="/labcas-ui/assets/js/plugins/chartist.min.js"></script>
<!--  Notifications Plugin    -->
<script src="/labcas-ui/assets/js/plugins/bootstrap-notify.js"></script>
<!--  jVector Map  -->
<script src="/labcas-ui/assets/js/plugins/jquery-jvectormap.js" type="text/javascript"></script>
<!--  Plugin for Date Time Picker and Full Calendar Plugin-->
<script src="/labcas-ui/assets/js/plugins/moment.min.js"></script>
<!--  DatetimePicker   -->
<script src="/labcas-ui/assets/js/plugins/bootstrap-datetimepicker.js"></script>
<!--  Sweet Alert  -->
<script src="/labcas-ui/assets/js/plugins/sweetalert2.min.js" type="text/javascript"></script>
<!--  Tags Input  -->
<script src="/labcas-ui/assets/js/plugins/bootstrap-tagsinput.js" type="text/javascript"></script>
<!--  Sliders  -->
<script src="/labcas-ui/assets/js/plugins/nouislider.js" type="text/javascript"></script>
<!--  Bootstrap Select  -->
<script src="/labcas-ui/assets/js/plugins/bootstrap-selectpicker.js" type="text/javascript"></script>
<!--  jQueryValidate  -->
<script src="/labcas-ui/assets/js/plugins/jquery.validate.min.js" type="text/javascript"></script>
<!--  Plugin for the Wizard, full documentation here: https://github.com/VinceG/twitter-bootstrap-wizard -->
<script src="/labcas-ui/assets/js/plugins/jquery.bootstrap-wizard.js"></script>
<!--  Bootstrap Table Plugin -->
<script src="/labcas-ui/assets/js/plugins/bootstrap-table.js"></script>
<!--  DataTable Plugin -->
<script src="/labcas-ui/assets/js/plugins/jquery.dataTables.min.js"></script>
<!--  Full Calendar   -->
<script src="/labcas-ui/assets/js/plugins/fullcalendar.min.js"></script>
<!-- Control Center for Now Ui Dashboard: parallax effects, scripts for the example pages etc -->
<script src="/labcas-ui/assets/js/light-bootstrap-dashboard.js?v=2.0.1" type="text/javascript"></script>
<!-- Light Dashboard DEMO methods, don't include it in your project! -->
<link href="/labcas-ui/assets/css/labcas/custom.css" rel="stylesheet" />
<script src="/labcas-ui/assets/js/plugins/js.cookie.js"></script>
<script src="https://cdn.jsdelivr.net/npm/dcmjs@0.23.0/build/dcmjs.min.js"></script>
<script src="/labcas-ui/assets/js/labcas/labcas-sidebar.js"></script>
<script src="/labcas-ui/assets/js/labcas/authentication.js?version=7.0.0"></script>
<script src="/labcas-ui/assets/js/labcas/utils.js?version=7.0.0"></script>
<script src="/labcas-ui/assets/js/labcas/search.js?version=7.0.0"></script>
<script type="text/javascript">
    $(document).ready(function() {
        console.log('OHIF index page loaded');
        initCookies();
        $('#viewerProgressModal').modal({backdrop:'static', keyboard:false});
        $('#dicomViewer').on('load', function(){
            $('#viewerProgressModal').modal('hide');
        });

        $( "#head_template" ).load("/labcas-ui/templates.html #head_template");
        $( "#nav_template" ).load("/labcas-ui/templates.html?2 #nav_template", function() {
            $( "#username_placeholder_second" ).text(Cookies.get('user'));
            if (Cookies.get('user') == "Sign in"){$( "#username_placeholder_third" ).text(Cookies.get('user'));}
            set_cart_status();
	    $("#loggedout_msg").hide();
        });

	$( "#footer_template" ).load("/labcas-ui/templates.html?version=7.0.0 #footer_template_"+localStorage.getItem("environment_name"));

        $( "#sidebar_placeholder" ).load("/labcas-ui/sidebar_"+localStorage.getItem("environment_name")+".html?9" );

        var get_var = get_url_vars();
        
		var breadcrumb = '<li class="breadcrumb-item"><a href="/labcas-ui/m/index.html">Home</a></li><li class="breadcrumb-item">OHIF Labcas Viewer</li>';
        if (Cookies.get("login_redirect") && (Cookies.get("login_redirect").includes("dataset_id=") || Cookies.get("login_redirect").includes("file_id="))){
		var dataset_file_rep = "dataset_id=";
		if (Cookies.get("login_redirect").includes("file_id=")){
			dataset_file_rep = "file_id=";
		}
		var dataset_id = Cookies.get("login_redirect").split(dataset_file_rep)[1];

            var data_split = dataset_id.split("/");
            var url_prefix = "";
            for (i = 0; i < data_split.length; i++) {
                if(i == 0){
                    breadcrumb += '<li class="breadcrumb-item active" aria-current="page"><a href="/labcas-ui/c/index.html?collection_id='+data_split[i]+'">'+data_split[i].replace(/_/g," ")+'</a></li>';
                }else if (i == data_split.length -1){
                    breadcrumb += '<li class="breadcrumb-item active" aria-current="page"><a href="'+Cookies.get("login_redirect")+'">'+data_split[i].replace(/_/g," ")+'</a></li>';
                }else{
                    breadcrumb += '<li class="breadcrumb-item active" aria-current="page"><a href="/labcas-ui/d/index.html?'+"dataset_id="+data_split.slice(0,i+1).join("/")+'">'+data_split[i].replace(/_/g," ")+'</a></li>';
                }
            }
            breadcrumb += '<li class="breadcrumb-item active" aria-current="page">Dicom Viewer</li>';
        }
        else if(localStorage.getItem("hierarchy_dict_current")){

        var hierarchy = JSON.parse(localStorage.getItem("hierarchy_dict_current"));
        var breadcrumb_hierarchy = [];
        for (var i = 0; i < hierarchy[0].length; i++) {
            console.log(hierarchy[1][i]);
            breadcrumb_hierarchy.push(hierarchy[0][i]+": "+String(hierarchy[1][i]));
        }
        var data_split = breadcrumb_hierarchy;
        var url_prefix = "";
        for (i = 0; i < data_split.length; i++) {
            if(i == 0){
                breadcrumb += '<li class="breadcrumb-item active" aria-current="page"><a href="/labcas-ui/c/index.html?collection_id='+localStorage.getItem('last_collection_id')+'">'+localStorage.getItem('last_collection_id').replace(/_/g," ")+'</a></li>';
                breadcrumb += '<li class="breadcrumb-item active" aria-current="page"><a href="/labcas-ui/cd/index.html?backtrack_ind='+i+'">'+data_split[i].replace(/_/g," ")+'</a></li>';
            }else if (i == data_split.length -1){
                breadcrumb += '<li class="breadcrumb-item active" aria-current="page">'+data_split[i].replace(/_/g," ")+'</li>';
            }else{
                breadcrumb += '<li class="breadcrumb-item active" aria-current="page"><a href="/labcas-ui/cd/index.html?backtrack_ind='+i+'">'+data_split[i].replace(/_/g," ")+'</a></li>';
            }
        }


        }

        if (Cookies.get("login_redirect") && Cookies.get("login_redirect").includes("search=")){
            breadcrumb += '<li class="breadcrumb-item active" aria-current="page"><a href="'+Cookies.get("login_redirect")+'">Search</a></li>';
            breadcrumb += '<li class="breadcrumb-item active" aria-current="page">Dicom Viewer</li>';
        }
		$('#breadcrumb').html(breadcrumb);
        
        console.log("Using simulated URL: " + encodeURIComponent('/simulated.json'));
        $('#dicomViewer')
            .on('load', function() { console.log('OHIF viewer loaded'); })
            .attr('src', "/labcas-ui/ohif/viewer/dicomjson?url=" + encodeURIComponent('/labcas-ui/simulated.json?t=' + Date.now()));
        console.log('OHIF iframe set, waiting for viewer to load');
    });
</script>

</html>

<!DOCTYPE html>
<html lang="en">
  <head>
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <div id="head_template"></div>
    <style>
        .table {
            table-layout: auto;  /* Allows columns to adjust width naturally */
            width: auto;  /* Prevents forcing it to fit 100% */
            border-collapse: collapse;
            white-space: nowrap;  /* Prevents text from wrapping */
        }

        .table th, .table td {
            min-width: 50px;  /* Adjust column width to prevent compression */
            padding: 10px;  /* Adds spacing */
            text-align: left;
            vertical-align: middle;
        }
    </style>
  </head>
  <body class="sidebar-mini">
    <div id="ml_wizard_template"></div>
    <div class="wrapper">
      <div id='sidebar_placeholder'></div>
      <div id='load'>
        <br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br>
        <center>
          <img class="collapse show" height="200px" width="200px" src="/nist/assets/img/loading.gif?2">
        </center>
      </div>
      <div id="main-panel" class="main-panel" style="visibility:hidden">
        <!-- Navbar -->
        <div id="nav_template"></div>
        <!-- End Navbar -->
        <div class="content" style="margin-top: -20px">
          <br>
          <br>
          <br>
          <div class="container-fluid">
            <div class="row" style="margin-bottom: 5px">
              <div class="col-lg-3 col-sm-6" id="file_stat_template"></div>
              <!--<div class="col-lg-3 col-sm-6" id="favorite_stat_template"></div>-->
            </div>
            <div class="row">
              <div class="col-md-12">
                <nav aria-label="breadcrumb">
                  <ol id="breadcrumb" class="breadcrumb"></ol>
                </nav>
              </div>
            </div>
            <div class="row">
              <div class="col-md-12">
                <div class="card ">
                  <div class="card-header">
                    <h4 class="card-title">
                      <div id="datasettitle"></div>
                    </h4>
                    <p class="card-category">Dataset Details</p>
                  </div>
                  <div class="card-body">
                            <button id="virtual_dataset_collapse" class="btn btn-primary">Expand</button>
                    <div class="table-responsive">
                      <table class="table" id="datasetdetails-table">
                        <tbody>
                          <center>
                            <img id="loading_dataset" class="collapse show" height="50px" width="50px" src="/nist/assets/img/loading.gif">
                          </center>
                          <tr id="toggle-row">
                          <td colspan="2">
                          </td>
                        </tbody>
                      </table>
                    </div>
                  </div>
                </div>
              </div>

                <div class="col-md-12 ml-auto mr-auto" id="dataset_level_gantt">
                  <div class="card card-tasks">
                    <div class="card-header ">
                      <h4 class="card-title">Cell Line Gantt</h4>
                      <p class="card-category">Explore or Download</p>
                    </div>
                    <div class="card-body" style="padding: 0px 15px 10px 15px">
                      <div class="table-full-width">
                        <div id="metadata_div2">
                          <iframe id="gantt" frameBorder="0" style="border: none; box-shadow: -2px 2px 2px 2px rgba(0,0,0,0.75); transform: translate(-2px, 2px);" height="350px" width="100%"></iframe>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
                <div class="col-md-12 ml-auto mr-auto" id="dataset_level_telemetry">
                  <div class="card card-tasks">
                    <div class="card-header ">
                      <h4 class="card-title">Cell Line Telemetry</h4>
                      <p class="card-category">Explore or Download</p>
                    </div>
                    <div class="card-body" style="padding: 0px 15px 10px 15px">
                      <div class="table-full-width">
                        <div id="metadata_div2">
                          <iframe id="telemetry" frameBorder="0" style="border: none; box-shadow: -2px 2px 2px 2px rgba(0,0,0,0.75); transform: translate(-2px, 2px);" height="500px" width="100%"></iframe>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
            </div>
            <div class="col-md-12 ml-auto mr-auto" id="datasets_in_collection">
                    <div class="card card-tasks">
                    <div class="card-header ">
                        <h4 class="card-title">Virtual Hierarchy in this Dataset</h4>
                    </div>
                    <div class="card-body">
                                    Add Folder Grouping Heirarchy:
                                    <hr style="padding:0; padding-bottom:5px; margin: 0">
                        <input id="view_tags" type="text" value="1. Cohort,2. Fixative,3. Study" /><div>
                            <div class="row"><div class="col-md-10"><select id="view_tag_select" class="form-control input-sm" data-style="btn-default btn-outline" data-menu-style="dropdown-blue"><option>Default</option><!--<option value='fixative'>Fixative</option><option value='study'>Study</option><option value='gender'>Gender</option><option value='animal'>Animal Type</option><option value='stain'>Stain</option>--></select></div> <div class="col-md-1" id="virtual_expand_all_label" style="line-height: 36px; display: none">Expand All?</div><div class="col-md-1"><input type="checkbox" id="virtual_expand_all" class="form-control" style="display: none; width:36px;height:36px"></div></div>
                        <!--<input type="text" value="Amsterdam,Washington,Sydney,Beijing,Cairo" data-role="tagsinput" />-->
                        <div class="table-full-width">
                        <div id="hierarchy_">
                            <center><img alt='Please wait while this is loading' id="loading_hierarchy" class="collapse hide" height="50px" width="50px" src="/nist/assets/img/loading.gif"></center>
                        </div>

                        </div>
                    </div>
                    </div>
                </div>
                </div>

            <div class="row">
              <div id='children-datasets' style="display: none" class="col-md-12 ml-auto mr-auto">
                <div class="card card-tasks">
                  <div class="card-header ">
                    <h4 class="card-title" id="files-title">Children Datasets</h4>
                  </div>
                  <div class="card-body" id="children-datasets-section"></div>
                </div>
              </div>
              <div id='children-files' style="display: none" class="col-md-12 ml-auto mr-auto">
                <div class="card card-tasks">
                  <div class="card-header ">
                    <h4 class="card-title" id="files-title">Files in this hierarchy</h4>
                  </div>
                  <div class="card-body">
                    <table>
                      <tr>
                        <td>
                          <button id="download_sel" type="submit" onclick="download_files('files-table');" class="btn btn-primary">Download Selected</button>
                          <button id="download_met" type="submit" onclick="download_metadatas('files-table');" class="btn btn-primary">Download Metadata</button>
                          <!--<button id="fcs_sel" type="submit" onclick="window.location.replace('/nist/fcs')" class="btn btn-info">View Cytometry Files</button>-->
                        </td>
                        <td>
                            <input id="check_all" type='checkbox' value="all">&nbsp;All</input>
                        </td>
                      </tr>
                    </table>
                    <ul class="pagination pagination-no-border" id='hierarchy_files_pagination_top' style="float: right;"></ul>
                    <div class="table-full-width" style="overflow-x: auto; width: 100%;">
                      <table class="table" id="files-table">
                        <thead></thead>
                        <tbody>
                          <center>
                            <img id="loading_file" class="collapse show" height="50px" width="50px" src="/nist/assets/img/loading.gif">
                          </center>
                        </tbody>
                      </table>
                    </div>
                  </div>
                  <div class="card-footer ">
                    <hr>
                    <div class="stats">
                      <i class="now-ui-icons loader_refresh spin"></i>
                      <ul class="pagination pagination-no-border" id='hierarchy_files_pagination_bottom' style="float: right;"></ul>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <footer role='contentinfo' class='labcas-footer' id="footer_template"></footer>
      </div>
    </div>
    </div>
    </div>
<div class="modal fade modal-mini modal-primary" id="imageModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
                        <div class="modal-dialog" style="max-width: 1200px">
                            <div class="modal-content" style="width: 1200px">
                                <div class="modal-header justify-content-center">
                                    <div class="modal-profile">
                                        <i class="nc-icon nc-album-2"></i>
                                    </div>
                                </div>
                                <div class="modal-body">
                                    <img style="max-width:1000px;max-height:700px" id="image_placeholder">
                                </div>
                                <div class="modal-footer">
                    <button type="submit" class="btn btn-info btn-fill pull-right" data-dismiss="modal">Close</button>
                                </div>
                            </div>
                        </div>
                    </div>

    <div class="modal fade modal-mini modal-primary" id="redirectModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
      <div class="modal-dialog" style="max-width: 1000px">
        <div class="modal-content" style="width: 1000px">
          <div class="modal-header justify-content-center">
            <div class="modal-profile">
              <i class="nc-icon nc-bell-55"></i>
            </div>
          </div>
          <div class="modal-body">
            <p>
            <center><div id='download_warning'></div></center>
            </p>
          </div>
          <div class="modal-footer">
            <button type="submit" id="redirectModal_continue" onclick="window.location.replace('/nist/download.html?version=5.1.0')" class="btn btn-info btn-fill pull-right" data-dismiss="modal">Continue</button>
            <button type="submit" class="btn btn-warning btn-fill pull-right" data-dismiss="modal">Close</button>
          </div>
        </div>
      </div>
    </div>

  </body>
  <!--   Core JS Files   -->
  <script src="/nist/assets/js/core/jquery-3.5.1.min.js" type="text/javascript"></script>
  <script src="/nist/assets/js/core/popper.min.js" type="text/javascript"></script>
  <script src="/nist/assets/js/core/bootstrap.min.js" type="text/javascript"></script>
  <!--  Plugin for Switches, full documentation here: http://www.jque.re/plugins/version3/bootstrap.switch/ -->
  <script src="/nist/assets/js/plugins/bootstrap-switch.js"></script>
  <!--  Chartist Plugin  -->
  <script src="/nist/assets/js/plugins/chartist.min.js"></script>
  <!--  Notifications Plugin    -->
  <script src="/nist/assets/js/plugins/bootstrap-notify.js"></script>
  <!--  jVector Map  -->
  <script src="/nist/assets/js/plugins/jquery-jvectormap.js" type="text/javascript"></script>
  <!--  Plugin for Date Time Picker and Full Calendar Plugin-->
  <script src="/nist/assets/js/plugins/moment.min.js"></script>
  <!--  DatetimePicker   -->
  <script src="/nist/assets/js/plugins/bootstrap-datetimepicker.js"></script>
  <!--  Sweet Alert  -->
  <script src="/nist/assets/js/plugins/sweetalert2.min.js" type="text/javascript"></script>
  <!--  Tags Input  -->
  <script src="/nist/assets/js/plugins/bootstrap-tagsinput.js" type="text/javascript"></script>
  <!--  Sliders  -->
  <script src="/nist/assets/js/plugins/nouislider.js" type="text/javascript"></script>
  <!--  Bootstrap Select  -->
  <script src="/nist/assets/js/plugins/bootstrap-selectpicker.js" type="text/javascript"></script>
  <!--  jQueryValidate  -->
  <script src="/nist/assets/js/plugins/jquery.validate.min.js" type="text/javascript"></script>
  <!--  Plugin for the Wizard, full documentation here: https://github.com/VinceG/twitter-bootstrap-wizard -->
  <script src="/nist/assets/js/plugins/jquery.bootstrap-wizard.js"></script>
  <!--  Bootstrap Table Plugin -->
  <script src="/nist/assets/js/plugins/bootstrap-table.js"></script>
  <!--  DataTable Plugin -->
  <script src="/nist/assets/js/plugins/jquery.dataTables.min.js"></script>
  <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js"></script>
  <!--  Full Calendar   -->
  <script src="/nist/assets/js/plugins/fullcalendar.min.js"></script>
  <!-- Control Center for Now Ui Dashboard: parallax effects, scripts for the example pages etc -->
  <script src="/nist/assets/js/light-bootstrap-dashboard.js?v=2.0.6" type="text/javascript"></script>
  <script src="/nist/assets/js/plugins/js.cookie.js"></script>
  <script src="/nist/assets/js/labcas/labcas-sidebar.js"></script>
  <script src="/nist/assets/js/labcas/utils.js?version=5.1.0"></script>
  <script src="/nist/assets/js/labcas/hierarchy_filter_utils_fast.js?version=5.1.0"></script>
  <script src="/nist/assets/js/labcas/authentication.js?version=5.1.0"></script>
  <script src="/nist/assets/js/labcas/search.js?version=5.1.0"></script>
  <script src="/nist/assets/js/labcas/ml_wizard.js?version=5.1.0"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/lz-string/1.4.4/lz-string.min.js"></script>
  <script src="/nist/assets/js/plugins/typeahead.bundle.js"></script>
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-X0YH110WES"></script> <script> window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'G-X0YH110WES'); </script>
  <script type="text/javascript">
    var get_var = get_url_vars();
    document.onreadystatechange = function() {
      var state = document.readyState
      if (state == 'interactive') {
        document.getElementById('main-panel').style.visibility = "hidden";
      } else if (state == 'complete') {
        setTimeout(function() {
          document.getElementById('load').style.display = "none";
          document.getElementById('main-panel').style.visibility = "visible";
        }, 1000);
      }
    }

    $(document).ready(function() {
      initCookies();
      $("#head_template").load("/nist/templates.html #head_template");
      $("#nav_template").load("/nist/templates.html?version=5.1.0 #nav_template", function() {
        $("#username_placeholder_second").text(Cookies.get('user'));
        if (Cookies.get('user') == "Sign in") {
          $("#username_placeholder_third").text(Cookies.get('user'));
          $("#loggedout_msg").show();
        } else {
          $("#loggedout_msg").hide();
        }
      });
      //$("#favorite_stat_template").load("/nist/templates.html #favorite_stat_template");
      $("#file_stat_template").load("/nist/templates.html #file_stat_template");
      $("#dataset_stat_template").load("/nist/templates.html?version=5.1.0 #dataset_name_template");
      $("#collection_name_template").load("/nist/templates.html #collection_name_template");
      $("#footer_template").load("/nist/templates.html #footer_template_" + localStorage.getItem("environment_name"));
      $("#sidebar_placeholder").load("/nist/sidebar_" + localStorage.getItem("environment_name") + ".html?version=5.1.0");
      
      if (get_var["key"]) {
        Cookies.set("token", get_var["key"]);
        Cookies.set("user", get_var["user"]);
        Cookies.set("userpass", get_var["session"]);
      }
      
      Cookies.set("login_redirect", "/nist/cd/index.html");
      var hierarchy = JSON.parse(localStorage.getItem("hierarchy_dict_current"));


      //Cell Line specific code
      // Find the index of "CellCode" in the first row
        let cellCodeIndex = hierarchy[0].indexOf("MammalianCellCode");

        // If "CellCode" is found
        if(cellCodeIndex !== -1) {
            // Get the value in the second row at the same index
            let cellCodeValue = hierarchy[1][cellCodeIndex];

            // Append the value to the string
            //let url = "/nist/a/gantt3.html?cellcode=" + cellCodeValue;
            let url = "/nist/a/gantt-new-single.html?cellcode=" + cellCodeValue;
            let url_telemetry = "/nist/a/telemtry_dash.html?cellcode=" + cellCodeValue;

            // Assign the concatenated string to the src attribute of the iframe
            $("#gantt").attr("src", url);
            $("#telemetry").attr("src", url_telemetry);
            $("#dataset_level_gantt").show();
            $("#dataset_level_telemetry").show();
        } else {
            // 'CellCode' not found in the first row of the JSON data
            $("#dataset_level_gantt").hide();
            $("#dataset_level_telemetry").hide();
        }



      //Cell line specific code end


      if (get_var["backtrack_ind"]) {
        hierarchy[0] = hierarchy[0].slice(0, parseInt(get_var["backtrack_ind"]) + 1)
        hierarchy[1] = hierarchy[1].slice(0, parseInt(get_var["backtrack_ind"]) + 1)
      }
      if (!localStorage.getItem('last_collection_id').includes("NIST_Flow_Cytometry_Standards_Consortium")){
        $('#fcs_sel').hide();
      }
      var file_query = "";
      var file_query_tmp = {};
      var breadcrumb_hierarchy = [];
      
      for (var i = 0; i < hierarchy[0].length; i++) {
          
          if (hierarchy[1][i] != "None"){
                file_query += "&fq=(" + encodeURI(escapeRegExp(hierarchy[0][i])).replace(/:/g, '%3A').replace(/%5C&/g, '%5C%26') + ":" + encodeURI(escapeRegExp(String(hierarchy[1][i]))).replace(/%5C&/g, '%5C%26').replace(/%5C%20/g,"%20").replace(/%20/g,"%5C%20").replace(/ /g,"%5C%20").replace(/^None$/,"*") + ")";
          }else{
            file_query += "&fq=(-" + encodeURI(escapeRegExp(hierarchy[0][i])).replace(/:/g, '%3A').replace(/%5C&/g, '%5C%26') + ":" + "%5B*%20TO%20*%5D)";
          }
        file_query_tmp[encodeURI(escapeRegExp(hierarchy[0][i])).replace(/:/g, '%3A').replace(/%5C&/g, '%5C%26')] = encodeURI(escapeRegExp(String(hierarchy[1][i]))).replace(/%5C&/g, '%5C%26').replace(/%5C%20/g,"%20").replace(/%20/g,"%5C%20").replace(/ /g,"%5C%20");
        breadcrumb_hierarchy.push(hierarchy[0][i] + ": " + String(hierarchy[1][i]));
      }
      localStorage.setItem("hierarchy_file_query", file_query);
      var breadcrumb = '<li class="breadcrumb-item"><a href="/nist/m/index.html">Home</a></li>';
      var data_split = breadcrumb_hierarchy;
      var url_prefix = "";
      for (i = 0; i < data_split.length; i++) {
        if (i == 0) {
	  breadcrumb += '<li class="breadcrumb-item active" aria-current="page"><a href="/nist/c/index.html?collection_id='+localStorage.getItem('last_collection_id')+'">'+localStorage.getItem('last_collection_id').replace(/_/g," ")+'</a></li>';
          breadcrumb += '<li class="breadcrumb-item active" aria-current="page"><a href="/nist/cd/index.html?backtrack_ind='+i+'">'+data_split[i].replace(/_/g," ")+'</a></li>';
        } else if (i == data_split.length - 1) {
	  breadcrumb += '<li class="breadcrumb-item active" aria-current="page">'+data_split[i].replace(/_/g," ")+'</li>';
        } else {
           breadcrumb += '<li class="breadcrumb-item active" aria-current="page"><a href="/nist/cd/index.html?backtrack_ind='+i+'">'+data_split[i].replace(/_/g," ")+'</a></li>';
        }
      }
      $('#breadcrumb').html(breadcrumb);


      //Setup view tags
        var tagValues = ["Cohort","Fixative","Study","Gender","Animal Type","Stain"];
        var states = new Bloodhound({
                datumTokenizer: Bloodhound.tokenizers.obj.whitespace('value'),
                queryTokenizer: Bloodhound.tokenizers.whitespace,
                local: $.map(tagValues, function(tagValue) { return { value: tagValue }; })
        });

        states.initialize();
        var elt = $('#view_tags');
        elt.tagsinput({ itemValue: "value",
              typeaheadjs: {
              displayKey: 'value',
              source: states.ttAdapter()
              }
          });

        $('.bootstrap-tagsinput').sortable({
            items: 'span.badge.badge-azure',
            cancel: '.bootstrap-tagsinput input',
            stop: function(event, ui) {

                var newTagsOrder = [];
                $(this).find('span.badge.badge-azure').each(function() {
                    // Extract the text of the tag
                    var tagText = $(this).contents().filter(function() {
                        return this.nodeType === 3; // Node.TEXT_NODE
                    }).text().trim();
                    newTagsOrder.push({ value: tagText });
                });

                elt.tagsinput('removeAll');
                newTagsOrder.forEach(function(tagObj) {
                    elt.tagsinput('add', tagObj);
                });

                $('#hierarchy_').html("");
                generate_hierarchy_based_on_tags().catch((error) => console.error(error));
                localStorage.setItem("hierarchy_tags_" + localStorage.getItem('last_collection_id'), elt.val());
            }
        }).disableSelection();

        //elt.tagsinput('add', { "value": 1});
        $('#view_tag_select').change(function() {
        if (this.value != "Native Hierarchy") {
          $('#datasets-table').hide();
          $('#hierarchy_').show();
          $('#virtual_expand_all').show();
          $('#virtual_expand_all_label').show();
          if (this.value == "Default"){
              collection_hierarchy_default();
          }else{
              elt.tagsinput('add', {
                "value": this.value
              });
              generate_hierarchy_based_on_tags().catch((error) => console.error(error));
          }

        } else {
          $('#hierarchy_').hide();
          $('#datasets-table').show();
          $('#virtual_expand_all').hide();
          $('#virtual_expand_all_label').hide();
        }
      });

        localStorage.setItem("current_dataset_id",get_var["dataset_id"]);
        elt.on('itemAdded itemRemoved', function(event) {
            $('.bootstrap-tagsinput').sortable('refresh');

            $('#hierarchy_').html("");

            if (event.type == "itemRemoved"){
                generate_hierarchy_based_on_tags().catch((error) => console.error(error));
            }

            localStorage.setItem("hierarchy_tags_" + localStorage.getItem('last_collection_id'), elt.val());
            if (elt.val() == "") {
              $('#hierarchy_').hide();
              $('#virtual_expand_all').hide();
              $('#virtual_expand_all_label').hide();
              //$('#datasets-table').show();
            }
          });

            $('.twitter-typeahead').hide();
        setTimeout(function(){
            localStorage.setItem("last_dataset_id", get_var["dataset_id"]);
            init_file_checkboxes('none');
            obj_type = "dataset";
            collection_hierarchy_get(localStorage.getItem('last_collection_id'), "dataset");
        },1000);

      
      //Init shopping cart
      init_file_checkboxes("files-table");
      init_ml_wizard(localStorage.getItem('last_collection_id'));
      let extraFilters = [];
      setup_labcas_hierarchy_data(file_query, extraFilters, 0);
    });

    $("#check_all").change(function() {
      if (this.checked) {
        $('#download_sel').text("Download All");
        $('#download_sel').attr("onclick", "download_dataset('hierarchy_query')");
        $('#download_met').text("Download All Metadata");
        $('#download_met').attr("onclick", "download_metadatas('hierarchy_query')");
      } else {
        $('#download_sel').text("Download Selected");
        $('#download_sel').attr("onclick", "download_files('files-table')");
        $('#download_met').text("Download Metadata");
        $('#download_met').attr("onclick", "download_metadatas('files-table')");
        localStorage.setItem('dicoms', JSON.stringify([]));
        localStorage.setItem('download_list', JSON.stringify({}));
        localStorage.setItem('download_size', 0);
        window.location.reload();
      }
    });

    //Flow Cytometry function
    $("#fcs_sel").click(function() {
        var shinyFilePaths = selected_files('files-table');
        const data = JSON.stringify({shinyfilePaths: shinyFilePaths});
        localStorage.setItem('shinyfilePaths', data);
        //window.location.href = 'https://100.110.12.244/bcyto/?data=' + encodeURIComponent(data);
        window.location.href = '/nist/fcs/index.html';
    });
  </script>
</html>

<html>
    <head>
        <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css">
        <style>
            .modebar{
              display: none !important;
            }
            #chartsTable {
              border-collapse: collapse;
            }
            #chartsTable tr:not(:first-child) {
              border-top: 3pt dashed lightblue;
            }
            #detailsTable table {
                width: 100%;
                margin-top: 20px;
            }

            #detailsTable td {
                padding: 8px;
            }

            #detailsTable tr:nth-child(odd) {
                background-color: #f2f2f2;
            }

            .content-container {
                display: flex;
                justify-content: space-between;
            }

            .charts-container {
                flex: 3;
                margin-right: 10px;
            }

            .table-responsive {
                flex: 1;
                width: 25%;
                max-height: 350px;  /* Adjust this height based on your preference */
                overflow-y: auto;
                border: 1px solid #dee2e6;  /* Adding a border to match the table-bordered style */
            }
            .details-title {
                text-align: center;
                font-weight: bold;
            }
        </style>
    </head>
    <body>
        <div class="content-container">
            <div class="charts-container">
        <table id="chartsTable" style="width:100%">
            <tr style="width:100%">
                <td style="width:7%; padding-left: 20px">
                    <div id="chartDiv1_title"></div> 
                </td>
                <td style="width:100%">
                    <div id="chartDiv1" class="chartDiv" style="max-width: 90%; width: 100%; height: 200px"></div>
                </td>
            </tr>
            <tr style="width:100%">
                <td style="width:7%; padding-left: 20px">
                    <div id="chartDiv2_title"></div> 
                </td>
                <td style="width:100%">
                    <div id="chartDiv2" class="chartDiv" style="max-width: 90%; width: 100%; height: 200px"></div>
                </td>
            </tr>
            <tr style="width:100%">
                <td style="width:7%; padding-left: 20px">
                    <div id="chartDiv3_title"></div> 
                </td>
                <td style="width:100%">
                    <div id="chartDiv3" class="chartDiv" style="max-width: 90%; width: 100%; height: 200px"></div>
                </td>
            </tr>
        </table>
        </div>
        <div id="detailsContainer" class="table-responsive">
            <h3 class="details-title">Event Details</h3><hr>
        <table id="detailsTable" class="table table-bordered">
                    <thead>
                        <tr>
                        </tr>
                    </thead>
                    <tbody id="detailsBody">
                    </tbody>
                </table>    
        </div>
        </div>
    </body>

<script>


// Extract unique ExpansionTypes and assign a random color to each
const expansionTypeColors = {};
// Create an empty array to store the chart data
const lightColorMap = {
    'Start': 'lightblue',
    'Monitor': 'lightgreen',
    'Feed': 'moccasin',
    'Passage': 'wheat',
    'Transfer': 'thistle',
    'Stop': 'lightsalmon'
};
const colorMap = {
    'Start': 'blue',
    'Monitor': 'green',
    'Feed': 'orange',
    'Passage': 'brown',
    'Transfer': 'purple',
    'Stop': 'red'
};

function formatDateToISOWithoutTime(dateObj) {
    const date = new Date(dateObj);
    const year = date.getUTCFullYear();
    const month = String(date.getUTCMonth() + 1).padStart(2, '0'); // Months are 0 indexed, so +1 and pad to MM format
    const day = String(date.getUTCDate()).padStart(2, '0');

    return `${year}-${month}-${day}`;
}

function getShape(eventType) {
    console.log(eventType);
    switch (eventType) {
      case 'Start':
        return 'triangle-right-open';
      case 'Monitor':
        return 'square-cross';
      case 'Feed':
        return 'square-cross';
      case 'Passage':
        return 'square-cross';
      case 'Stop':
        return 'triangle-left';
      case 'Transfer':
        return 'square-cross-open';
    }
}

function getColor(expansionType) {
    return colorMap[expansionType];
}

let combinedData = {};

async function createGanttChart(cell_type, divid) {
    const chartData = [];
    var cell_button_html = "<button id='"+divid+"_toggle' class='btn btn-primary'>"+cell_type+"</button>"
    document.getElementById(divid+'_title').innerHTML = cell_button_html;
    //const response = await fetch('https://labcas.jpl.nasa.gov/nist/assets/tmp/data.json');
    console.log("HERE");

    let response = await fetch('https://ddsa-labcas-staging.jpl.nasa.gov/labcas-ui/assets/tmp/'+cell_type+'_new_data.json');
    if (cell_type == "Jurkat"){
        response = await fetch('https://ddsa-labcas-staging.jpl.nasa.gov/labcas-ui/assets/tmp/test-cell-line2.json');
    }
    const data = await response.json();

    // Iterate through the data and create a trace for each unique CellCode
    data.forEach((row) => {
      // Check if the CellCode trace already exists
        if (!row.MammalianCellCode){
            return;
        }

      const key = row.MammalianCellCode + '_' + formatDateToISOWithoutTime(row.EventDate);

      if (!combinedData[key]) {
        combinedData[key] = {
            MammalianCellCode: row.MammalianCellCode,
            EventDate: row.EventDate,
            EventTypes: [row.EventType],
            Notes: [row.Notes ? row.Notes : ""],
            InstrumentHandles: [row.InstrumentHandle],
            PreEventCellConcentrations: [row.PreEventCellConcentration],
            PostEventCellConcentrations: [row.PostEventCellConcentration],
            PostEventCultureVolumes: [row.PostEventCultureVolume],
            PostEventCultureVolumeUnits: [row.PostEventCultureVolumeUnits],
            Count: 1
        };
      } else {
            combinedData[key].EventTypes.push(row.EventType);
            combinedData[key].Notes.push(row.Notes ? row.Notes : "");
            combinedData[key].InstrumentHandles.push(row.InstrumentHandle);
            combinedData[key].PreEventCellConcentrations.push(row.PreEventCellConcentration);
            combinedData[key].PostEventCellConcentrations.push(row.PostEventCellConcentration);
            combinedData[key].PostEventCultureVolumes.push(row.PostEventCultureVolume);
            combinedData[key].PostEventCultureVolumeUnits.push(row.PostEventCultureVolumeUnits);
            combinedData[key].Count = combinedData[key].Count + 1
      }


      existingTrace = chartData.find((trace) => trace.name === row.MammalianCellCode);
      expansionTypeColor = getColor(row.EventType);
      notes = row.Notes ? row.Notes : "";
      eventTypeShape = getShape(row.EventType)


      // Create a new trace if it doesn't exist
      if (!existingTrace) {
        existingTrace = {
          name: row.MammalianCellCode,
          x: [new Date(row.EventDate)],
          y: [row.MammalianCellCode],
          mode: 'markers+lines',
          line: { color: expansionTypeColor, width: 2 },
          marker: {
            symbol: [eventTypeShape],
            color: [expansionTypeColor],
            size: 15,
          },
        };
        chartData.push(existingTrace);
      } else {
        existingTrace.x.push(new Date(row.EventDate));
        existingTrace.y.push(row.MammalianCellCode);
        existingTrace.marker.symbol.push(eventTypeShape);
        existingTrace.marker.color.push(expansionTypeColor);
      }
    });


    var layout = {
      margin: {
        l: 180,
        r: 0,
        b: 20,
        t: 50,
        pad: 2
      },
        xaxis: {
    //title: 'Event Date',
    showline: true,
    showgrid: false,
            side: 'top',
    position: 1
  },
        yaxis: {
        //title: 'Cell Code',
      },
        showlegend: false,
        hovermode: 'closest'
    };

    // Create the Gantt chart
    Plotly.newPlot(divid, chartData, layout, {
      displayModeBar: false
    });

    // Add this code after the Plotly.newPlot() call
document.getElementById(divid).on('plotly_hover', function(data){
    const uniqueId = data.points[0].y + '_' + formatDateToISOWithoutTime(data.points[0].x);
    console.log("row");
    console.log(uniqueId);
    console.log(combinedData[uniqueId]);
    displayDetailsTable(combinedData[uniqueId]);
});


}

function displayDetailsTable(row) {
    const tableContainer = document.getElementById('detailsTable');
    let tableHTML = '<table class="table table-bordered table-hover">';

    row.EventTypes.forEach((eventType, index) => {
        let bgColor = lightColorMap[eventType];

        tableHTML += `<tr style="background-color: ${bgColor}"><td><b>EventType</b></td><td>${eventType}</td></tr>`;
        tableHTML += `<tr><td><b>EventDate</b></td><td>${new Date(row.EventDate).toLocaleDateString()}</td></tr>`;
        tableHTML += `<tr><td><b>Notes</b></td><td>${row.Notes[index]}</td></tr>`;
        tableHTML += `<tr><td><b>InstrumentHandle</b></td><td>${row.InstrumentHandles[index]}</td></tr>`;
        tableHTML += `<tr><td><b>PreEventCellConcentration</b></td><td>${row.PreEventCellConcentrations[index]}</td></tr>`;
        tableHTML += `<tr><td><b>PostEventCellConcentration</b></td><td>${row.PostEventCellConcentrations[index]}</td></tr>`;
        tableHTML += `<tr><td><b>PostEventCultureVolume</b></td><td>${row.PostEventCultureVolumes[index]} ${row.PostEventCultureVolumeUnits[index]}</td></tr>`;
        tableHTML += `<tr><td><b>File Count</b></td><td>${row.Count}</td></tr>`;
    });

    tableHTML += '</table>';
    tableContainer.innerHTML = tableHTML;
    tableContainer.style.display = 'block';
}

createGanttChart('Jurkat','chartDiv1');
createGanttChart('CHO-K1','chartDiv2');
createGanttChart('293T','chartDiv3');

$(document).ready(function() {
  $('#chartDiv1_title').on('click', function() {
    $('#chartDiv1').toggle();
    if ($('#chartDiv1_toggle').hasClass('btn-primary')) {
        $('#chartDiv1_toggle').removeClass('btn-primary').addClass('btn-warning');
    } else {
        $('#chartDiv1_toggle').removeClass('btn-warning').addClass('btn-primary');
    }
  });

  $('#chartDiv2_title').on('click', function() {
    $('#chartDiv2').toggle();
      if ($('#chartDiv2_toggle').hasClass('btn-primary')) {
        $('#chartDiv2_toggle').removeClass('btn-primary').addClass('btn-warning');
    } else {
        $('#chartDiv2_toggle').removeClass('btn-warning').addClass('btn-primary');
    }
  });

  $('#chartDiv3_title').on('click', function() {
    $('#chartDiv3').toggle();
      if ($('#chartDiv3_toggle').hasClass('btn-primary')) {
        $('#chartDiv3_toggle').removeClass('btn-primary').addClass('btn-warning');
    } else {
        $('#chartDiv3_toggle').removeClass('btn-warning').addClass('btn-primary');
    }
  });
});

</script>

</html>
